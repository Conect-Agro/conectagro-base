stages:
  - build
  - test

variables:
  DB_HOST: mysql
  DB_USER: test_user
  DB_PASSWORD: test_password
  DB_NAME: test_db
  JWT_SECRET: test_jwt_secret_key
  JWT_EXPIRATION: "1h"
  JWT_COOKIE_EXPIRES: 1
  PORT: 3000

cache:
  paths:
    - node_modules/

default:
  image: node:18
  services:
    - name: mysql:8.0
      alias: mysql
  before_script:
    - apt-get update && apt-get install -y default-mysql-client
    - until mysqladmin ping -h mysql -u root -proot_password --silent; do sleep 1; done
    - mysql -h mysql -u root -proot_password < conectagro_schema.sql

build:
  stage: build
  script:
    - npm install
  artifacts:
    paths:
      - node_modules/
      - . # asegura que los tests puedan acceder al cÃ³digo

test_register:
  stage: test
  script:
    - npm test

test_login:
  stage: test
  script:
    - npm run test:login

stages:
  - build
  - test

variables:
  DB_HOST: mysql
  DB_USER: test_user
  DB_PASSWORD: test_password
  DB_NAME: test_db
  JWT_SECRET: test_jwt_secret_key
  JWT_EXPIRATION: "1h"
  JWT_COOKIE_EXPIRES: 1
  PORT: 3000
  MYSQL_ROOT_PASSWORD: root_password

cache:
  paths:
    - node_modules/

default:
  image: node:18
  services:
    - name: mysql:8.0
      alias: mysql
      variables:
        MYSQL_ROOT_PASSWORD: root_password
        MYSQL_DATABASE: test_db

  before_script:
    - apt-get update && apt-get install -y default-mysql-client
    - echo "Esperando a que MySQL esté disponible..."
    - until mysqladmin ping -h mysql -u root -p$MYSQL_ROOT_PASSWORD --silent; do sleep 1; done
    - echo "MySQL está disponible, configurando la base de datos..."
    - mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD -e "CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';"
    - mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD -e "GRANT ALL ON ${DB_NAME}.* TO '${DB_USER}'@'%';"
    - |
      if [ -f "./conectagro_schema.sql" ]; then
        echo "Importando esquema de base de datos..."
        mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD ${DB_NAME} < ./conectagro_schema.sql
      else
        echo "ADVERTENCIA: El archivo de esquema no existe en la ruta esperada"
      fi
    - |
      if [ -f "./test_db_schema.sql" ]; then
        echo "Importando esquema de base de datos..."
        mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD ${DB_NAME} < ./test_db_schema.sql
      else
        echo "ADVERTENCIA: El archivo de esquema no existe en la ruta esperada"
      fi
    - npm install

build:
  stage: build
  script:
    - echo "Construyendo la aplicación..."
    - npm install
    # Aseguramos que Jest esté instalado explícitamente
    - npm install --save-dev jest
  artifacts:
    paths:
      - node_modules/
      - .

# Mirar que hay dentro de la base de datos
debug_db:
  stage: test
  script:
    - echo "Inspeccionando base de datos..."
    - mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD -e "USE ${DB_NAME}; SHOW TABLES;"
    - mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD -e "USE ${DB_NAME}; SELECT * FROM users;"

test_register:
  stage: test
  script:
    - echo "Ejecutando pruebas de registro..."
    - npx jest test/auth/register.js --passWithNoTests


test_login:
  stage: test
  script:
    - echo "Ejecutando pruebas de login..."
    - npx jest test/auth/login.js --passWithNoTests

test_cart:
  stage: test
  script:
    - echo "Ejecutando pruebas del carrito..."
    - npx jest test/cart/add-to-cart.js --passWithNoTests

stages:
  - build
  - test
  - deploy

variables:
  DB_HOST: mysql
  DB_USER: test_user
  DB_PASSWORD: test_password
  DB_NAME: test_db
  JWT_SECRET: test_jwt_secret_key
  JWT_EXPIRATION: "1h"
  JWT_COOKIE_EXPIRES: 1
  PORT: 3000
  MYSQL_ROOT_PASSWORD: root_password

cache:
  paths:
    - node_modules/

default:
  image: node:18
  services:
    - name: mysql:8.0
      alias: mysql
      variables:
        MYSQL_ROOT_PASSWORD: root_password
        MYSQL_DATABASE: test_db

  before_script:
    - apt-get update && apt-get install -y default-mysql-client
    - echo "Esperando a que MySQL esté disponible..."
    - until mysqladmin ping -h mysql -u root -p$MYSQL_ROOT_PASSWORD --silent; do sleep 1; done
    - echo "MySQL está disponible, configurando la base de datos..."
    - mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD -e "CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';"
    - mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD -e "GRANT ALL ON ${DB_NAME}.* TO '${DB_USER}'@'%';"
    - |
      if [ -f "./conectagro_schema.sql" ]; then
        echo "Importando esquema de base de datos..."
        mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD ${DB_NAME} < ./conectagro_schema.sql
      else
        echo "ADVERTENCIA: El archivo de esquema no existe en la ruta esperada"
      fi
    - |
      if [ -f "./test_db_schema.sql" ]; then
        echo "Importando esquema de base de datos..."
        mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD ${DB_NAME} < ./test_db_schema.sql
      else
        echo "ADVERTENCIA: El archivo de esquema no existe en la ruta esperada"
      fi
    - npm install

build:
  stage: build
  script:
    - echo "Construyendo la aplicación..."
    - npm install --save-dev jest
  artifacts:
    paths:
      - node_modules/
      - .

debug_db:
  stage: test
  only:
    - devSamir
  script:
    - echo "Inspeccionando base de datos..."
    - mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD -e "USE ${DB_NAME}; SHOW TABLES;"
    - mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD -e "USE ${DB_NAME}; SELECT * FROM users;"

test_register:
  stage: test
  only:
    - devSamir
  script:
    - echo "Ejecutando pruebas de registro..."
    - npx jest test/auth/register.js --passWithNoTests

test_login:
  stage: test
  only:
    - devSamir
  script:
    - echo "Ejecutando pruebas de login..."
    - npx jest test/auth/login.js --passWithNoTests

test_cart:
  stage: test
  only:
    - devSamir
  script:
    - echo "Ejecutando pruebas del carrito..."
    - npx jest test/cart/add-to-cart.js --passWithNoTests

deploy_production:
  stage: deploy
  image: alpine:latest
  only:
    - main
  before_script:
    - apk add --no-cache openssh-client git
  script:
    - echo "🔐 Configurando clave SSH..."
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    # Validar la clave antes de usarla
    - ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub || (echo "❌ Clave SSH inválida" && exit 1)
    - ssh-keyscan -H 68.183.119.29 >> ~/.ssh/known_hosts
    - echo "🚀 Conectando y desplegando en el servidor..."
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no deploy@68.183.119.29 "
        cd ~/conectagro/conectagro &&
        git pull origin main &&
        echo \"✅ Código actualizado.\" &&
        docker compose down &&
        docker compose up -d --build
      "